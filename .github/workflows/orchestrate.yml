name: Claude Code Orchestrator

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to orchestrate'
        required: true
        type: string
      max_ems:
        description: 'Maximum number of Engineering Managers'
        required: false
        type: string
        default: '3'
      max_workers_per_em:
        description: 'Maximum Workers per EM'
        required: false
        type: string
        default: '3'
      review_wait_minutes:
        description: 'Minutes to wait for human code review before auto-merging PRs'
        required: false
        type: string
        default: '5'
    secrets:
      CLAUDE_CONFIGS:
        description: 'JSON array of Claude API configurations'
        required: true
      CCO_PAT:
        description: 'GitHub PAT with repo and workflow permissions'
        required: true

jobs:
  orchestrate:
    name: E2E Orchestration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout orchestrator
        uses: actions/checkout@v4
        with:
          repository: mohsen1/claude-orchestrator-action
          path: orchestrator

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          path: target
          token: ${{ secrets.CCO_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build
        run: cd orchestrator && npm ci && npm run build

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        working-directory: target
        run: |
          git config user.name "Claude Orchestrator"
          git config user.email "orchestrator@claude.ai"

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CCO_PAT }}
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }}
            });
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');

      - name: Run E2E Orchestration
        working-directory: target
        env:
          GITHUB_TOKEN: ${{ secrets.CCO_PAT }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          CLAUDE_CONFIGS: ${{ secrets.CLAUDE_CONFIGS }}
          MAX_EMS: ${{ inputs.max_ems }}
          MAX_WORKERS_PER_EM: ${{ inputs.max_workers_per_em }}
          REVIEW_WAIT_MINUTES: ${{ inputs.review_wait_minutes }}
        run: |
          export REPO_OWNER="${GITHUB_REPOSITORY%/*}"
          export REPO_NAME="${GITHUB_REPOSITORY#*/}"
          node ../orchestrator/dist/e2e/run.js

      - name: Post status comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CCO_PAT }}
          script: |
            const issueNumber = ${{ inputs.issue_number }};
            const status = '${{ job.status }}';
            const workflowUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            
            let body;
            if (status === 'success') {
              body = `## Orchestration Complete\n\nThe implementation has been created. Check for a new PR.\n\n[View Workflow Run](${workflowUrl})\n\n---\n*Updated: ${new Date().toISOString()}*`;
            } else {
              body = `## Orchestration Failed\n\n[View Workflow Run](${workflowUrl}) for details.\n\n---\n*Updated: ${new Date().toISOString()}*`;
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100
            });
            
            const existing = comments.find(c => c.body?.includes('## Orchestration'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });
            }
