name: Claude Code Orchestrator

on:
  workflow_call:
    inputs:
      event_type:
        description: 'Event type that triggered this workflow'
        required: true
        type: string
      issue_number:
        description: 'Issue number (for issue_labeled events)'
        required: false
        type: string
      pr_number:
        description: 'PR number (for PR events)'
        required: false
        type: string
      branch:
        description: 'Branch name (for push/PR events)'
        required: false
        type: string
      review_state:
        description: 'Review state (approved, changes_requested, commented)'
        required: false
        type: string
      review_body:
        description: 'Review body text'
        required: false
        type: string
      max_ems:
        description: 'Maximum number of Engineering Managers'
        required: false
        type: string
        default: '10'
      max_workers_per_em:
        description: 'Maximum Workers per EM'
        required: false
        type: string
        default: '3'
      review_wait_minutes:
        description: 'Minutes to wait for human code review (not used in event-driven mode)'
        required: false
        type: string
        default: '5'
      trigger_label:
        description: 'Label that triggers orchestration on issues'
        required: false
        type: string
        default: 'cco'
      pr_label:
        description: 'Label to add to all PRs created by orchestrator'
        required: false
        type: string
        default: 'cco'
      debug:
        description: 'Enable debug logging to a separate issue'
        required: false
        type: string
        default: 'false'
    secrets:
      CLAUDE_CONFIGS:
        description: 'JSON array of Claude API configurations'
        required: true
      CCO_PAT:
        description: 'GitHub PAT with repo and workflow permissions'
        required: true

jobs:
  orchestrate:
    name: Handle Event
    runs-on: ubuntu-latest
    steps:
      - name: Checkout orchestrator
        uses: actions/checkout@v4
        with:
          repository: mohsen1/claude-orchestrator-action
          path: orchestrator

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          path: target
          ref: ${{ inputs.branch || 'main' }}
          token: ${{ secrets.CCO_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build
        run: cd orchestrator && npm ci && npm run build

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        working-directory: target
        run: |
          git config user.name "Claude Orchestrator"
          git config user.email "orchestrator@claude.ai"

      - name: Run Event Handler
        working-directory: target
        env:
          GITHUB_TOKEN: ${{ secrets.CCO_PAT }}
          EVENT_TYPE: ${{ inputs.event_type }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          PR_NUMBER: ${{ inputs.pr_number }}
          BRANCH: ${{ inputs.branch }}
          REVIEW_STATE: ${{ inputs.review_state }}
          REVIEW_BODY: ${{ inputs.review_body }}
          CLAUDE_CONFIGS: ${{ secrets.CLAUDE_CONFIGS }}
          MAX_EMS: ${{ inputs.max_ems }}
          MAX_WORKERS_PER_EM: ${{ inputs.max_workers_per_em }}
          REVIEW_WAIT_MINUTES: ${{ inputs.review_wait_minutes }}
          PR_LABEL: ${{ inputs.pr_label }}
          CCO_DEBUG: ${{ inputs.debug }}
        run: |
          export REPO_OWNER="${GITHUB_REPOSITORY%/*}"
          export REPO_NAME="${GITHUB_REPOSITORY#*/}"
          node ../orchestrator/dist/orchestrator/run.js
