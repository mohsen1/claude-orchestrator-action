name: CCO Review Handler

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  handle-review:
    if: startsWith(github.event.pull_request.head.ref, 'cco/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout orchestrator action
        uses: actions/checkout@v4
        with:
          repository: mohsen1/claude-orchestrator-action
          path: orchestrator-action

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          path: target-repo
          token: ${{ secrets.CCO_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Parse PR context
        id: parse
        run: |
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_BODY="${{ github.event.pull_request.body || '' }}"

          # Get review state and body
          if [ "${{ github.event_name }}" == "pull_request_review" ]; then
            REVIEW_STATE="${{ github.event.review.state }}"
            REVIEW_BODY="${{ github.event.review.body || '' }}"
          else
            REVIEW_STATE="commented"
            REVIEW_BODY="${{ github.event.review_comment.body || '' }}"
          fi

          # Save to outputs
          {
            echo "head_ref=$HEAD_REF"
            echo "base_ref=$BASE_REF"
            echo "pr_number=$PR_NUMBER"
            echo "pr_body<<EOF"
            echo "$PR_BODY"
            echo "EOF"
            echo "review_state=$REVIEW_STATE"
            echo "review_body<<EOF"
            echo "$REVIEW_BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Run Review Handler
        env:
          GITHUB_TOKEN: ${{ secrets.CCO_PAT }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ steps.parse.outputs.pr_number }}
          PR_HEAD_REF: ${{ steps.parse.outputs.head_ref }}
          PR_BASE_REF: ${{ steps.parse.outputs.base_ref }}
          PR_BODY: ${{ steps.parse.outputs.pr_body }}
          REVIEW_STATE: ${{ steps.parse.outputs.review_state }}
          REVIEW_BODY: ${{ steps.parse.outputs.review_body }}
          CLAUDE_CONFIGS: ${{ secrets.CLAUDE_CONFIGS }}
        working-directory: target-repo
        run: node ../orchestrator-action/dist/review-handler/run.js

      - name: Handle failure
        if: failure()
        run: |
          echo "Failed to handle review. Check logs for details."
          exit 1
