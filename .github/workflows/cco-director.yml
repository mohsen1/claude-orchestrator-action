name: CCO Director

on:
  # Direct triggering from the target repo
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to orchestrate'
        required: true
        type: number
      resume:
        description: 'Resume existing orchestration'
        required: false
        type: boolean
        default: false
  # Called as a reusable workflow
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to orchestrate'
        required: false
        type: number
      resume:
        description: 'Resume existing orchestration'
        required: false
        type: boolean
        default: false
    secrets:
      CLAUDE_CONFIGS:
        description: 'JSON array of Claude API configurations'
        required: true
      CCO_PAT:
        description: 'GitHub PAT with repo and workflow permissions'
        required: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  direct:
    if: github.event.label.name == 'orchestrator' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout orchestrator action
        uses: actions/checkout@v4
        with:
          repository: mohsen1/claude-orchestrator-action
          path: orchestrator-action

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          path: target-repo
          token: ${{ secrets.CCO_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Director
        working-directory: target-repo
        env:
          GITHUB_TOKEN: ${{ secrets.CCO_PAT }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          ISSUE_TITLE: ${{ github.event.issue.title || '' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          CLAUDE_CONFIGS: ${{ secrets.CLAUDE_CONFIGS }}
          RESUME: ${{ inputs.resume || 'false' }}
          MAX_EMS: ${{ vars.MAX_EMS || '5' }}
          MAX_WORKERS_PER_EM: ${{ vars.MAX_WORKERS_PER_EM || '4' }}
          DISPATCH_STAGGER_MS: ${{ vars.DISPATCH_STAGGER_MS || '2000' }}
        run: node ../orchestrator-action/dist/director/run.js

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CCO_PAT }}
          script: |
            const issueNumber = ${{ github.event.issue.number || inputs.issue_number }};
            const issueTitle = '${{ github.event.issue.title || '' }}';
            const workflowRunUrl = `${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Find existing orchestrator comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100
            });

            const orchestratorComment = comments.find(comment =>
              comment.body?.includes('## ü§ñ Orchestration Status')
            );

            const errorBody = `## ü§ñ Orchestration Status

**Status:** ‚ùå Failed
**Work Branch:** \`unknown\`

### Error Details

**Error:** Workflow failed during execution. Check the workflow logs for more details.

[View Workflow Logs](${workflowRunUrl}) for more details.

---
*Last updated: ${new Date().toISOString()}*`;

            if (orchestratorComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: orchestratorComment.id,
                body: errorBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: errorBody
              });
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['orchestrator-failed']
            });
